<!DOCTYPE html>
<html>
  <head>
    <script src="./pantry.js"></script>
  </head>

  <body>
    <!---------------->
    <!--  Side bar  -->
    <!---------------->
    <div id="side-bar">
      <h1>&#129387; The Data Pantry </h1>
      <h3 style="text-decoration: underline;">your databases:</h3>
      <div id="db-list"><!-- Insert table names here --></div>
    </div>

    <!------------------------------------>
    <!--  Main content (table display)  -->
    <!------------------------------------>
    <div id="page-content">
      
      <div id="top-bar">
        <h2 id="table-name-display"><!--  Insert current table name here --></h2>
        <div id="user-auth"></div>
      </div>
      <div id="error"></div>

      <!-- Table display stuff -->
      <div id="table-display"><!-- Insert table and controls here  --></div>
      <div id="row-editor-container"><!--  Insert row editor here  --></div>
      <div id="action-button-container"><!--  Insert button here, like "New Row" etc  --></div>

    </div>

  </body>
  
  <script>

    //  GLOBAL DATA
    let db_list =   [];    //  List of all database names.
    let selected_db = '';
    let table_list = [];   //  List of table NAMES belonging to the selected DB. 
    let table = {};        //  Current selected table obj
    let selected_row = {}; 
    const column_data = [  //  All the properties used to define a table column
      ['Column name', 'name'],
      ['Column snakecase', 'snakecase'],
      ['Unique?', 'unique'],
      ['Required?', 'required'],
      ['Reference?', 'reference']
    ]
    const http = new XMLHttpRequest(); // todo: remove this

    //  BOOT
    function boot() {
      //  Load all tables, render side bar.
      Pantry.get_all_databases(function(_db_list) {
        if (!_db_list.error) {
          db_list = _db_list;
          render_side_bar();
          if (db_list) { load_database(db_list[0]);  }  //  Load the first table on startup
        } else {
          document.getElementById('error').innerHTML = _db_list.msg;
        }
      });

      //  Render login buttons or user profile + log out. . 
      render_login_buttons();
    }
    boot();
    

    ////
    ////  RENDER user auth
    ////
    function render_login_buttons() {
      //  Rendering login and register buttons
      document.getElementById('user-auth').innerHTML = '<button onclick="render_login_input()">Log in</button>&nbsp;&nbsp;&nbsp;&nbsp;';
      document.getElementById('user-auth').innerHTML += '<button onclick="render_register_input()">Register</button>';

    }

    function render_login_input() {
      let auth_input_html = '<div id="auth-input-box"><h3>Log in: </h3>';
      auth_input_html += '<div>Username: <input id="username"/> </div><br/>';
      auth_input_html += '<div>Password: <input id="pass" type="password" /></div><br/>';
      auth_input_html += '<div><button onclick="login()">Log in</button>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="render_login_buttons()">Close</button></div>';

      auth_input_html += '</div>';
      render_login_buttons();
      document.getElementById('user-auth').innerHTML += auth_input_html;
    }

    function render_register_input() {
      let auth_input_html = '<div id="auth-input-box"><h3>Register: </h3>';
      auth_input_html += '<div>Username: <input id="username"/> </div><br/>';
      auth_input_html += '<div>Password: <input id="pass" type="password" /></div><br/>';
      auth_input_html += '<div>Confirm pass: <input id="confirm-pass" type="password" /></div><br/>';
      auth_input_html += '<div><button onclick="register()">Register</button>&nbsp;&nbsp;&nbsp;&nbsp;<button onclick="render_login_buttons()">Close</button></div>';

      auth_input_html += '</div>';
      render_login_buttons();
      document.getElementById('user-auth').innerHTML += auth_input_html;
    }

    ////
    ////  RENDER side bar
    ////
    function render_side_bar() {
      document.getElementById('db-list').innerHTML = '';
      for (let i = 0; i < db_list.length; i++) {
        let selected_class = 'selected';
        if (selected_db != db_list[i]) {  selected_class = ''; }
        document.getElementById('db-list').innerHTML += `<div class="db-name ${selected_class}" onclick="load_database('${db_list[i]}')">${db_list[i]}</div>`;
        //  Render list of DB tables, if the DB is selected:
        // if (table.columns && table.columns.snakecase != db_list[i]) {  selected_class = ''; }
        if (selected_db == db_list[i]) {
          for (let j = 0; j < table_list.length; j++) {
            selected_class = '';
            if (table.columns && table_list[j] == table.columns.snakecase) {  selected_class = 'selected';  }
            document.getElementById('db-list').innerHTML += `<div class="table-name ${selected_class}" onclick="load_table('${table_list[j]}')">${table_list[j]}</div>`;
          }
        }
      }
      document.getElementById('db-list').innerHTML += `<div class="save-new-table" onclick="boot_table_maker()">+ Create a table</div>`;
    }

    ////
    ////  RENDER TABLE ROW EDITOR
    ////
    //  Render the table
    function render_table() {
      document.getElementById('table-name-display').innerHTML = `Table name: <b>${table.columns.name}</b>`;
      let table_string = `<table><tr>`
      //  Table header
      let columns = table.columns.columns;
      for (let i = 0; i < columns.length; i++) {
        //if (columns[i].snakecase == 'id') { continue; }
        table_string += `<th>${columns[i].snakecase}</th>`;
      }
      // table_string += `<th><!-- edit icon --></th>`;
      table_string += `</tr>`;

      //  Table rows
      let rows = table.rows;
      for (let i = 0; i < rows.length; i++) {
        let selected_class = 'class="selected-row"';
        if (selected_row.id != rows[i].id) {  selected_class = '';  }
        table_string += `<tr onclick="render_row_editor(${i})" ${selected_class}>`;
        for (let j = 0; j < columns.length; j++) {
          //if (columns[j].snakecase == 'id') { continue; }
          table_string += `<td>${rows[i][columns[j].snakecase]}</td>`;
        }
        // table_string += `<td>&#9999; &nbsp; &#128465;</td>`;
        table_string += `</tr>`;
      }
      table_string += `</table><br/>`;
      if (rows.length < 1) {  table_string += `<p><i>No rows in this table yet! </i></p>`;  }
      document.getElementById('table-display').innerHTML = table_string;
    }

    function render_add_row_btn() {
      let columns = table.columns.columns;
      let add_row_html = '<div id="row-editor">';
      add_row_html += '<h3>New row</h3>';
      for (let i = 0; i < columns.length; i++) {
        if (columns[i].snakecase == 'id') { continue; }
        add_row_html += `<div class="row-input">${columns[i].name}: <input type="text" id="i-${columns[i].snakecase}"></div>`;
      }
      add_row_html += `<div class="row-input"><button onclick="add_row()">Add row</button></div>`;
      add_row_html += `</div>`;
      document.getElementById('row-editor-container').innerHTML = add_row_html;
      document.getElementById('action-button-container').innerHTML = '';
    }

    //  Fired when a row is selected!
    function render_row_editor(i) {
      let columns = table.columns.columns;
      selected_row = table.rows[i];
      render_table();  //  Needed to highlight row
      let add_row_html = '<div id="row-editor">';
      add_row_html += `<h3>Row ${i}</h3>`;
      for (let i = 0; i < columns.length; i++) {
        if (columns[i].snakecase == 'id') { continue; }
        add_row_html += `<div class="row-input">${columns[i].name}: <input type="text" id="i-${columns[i].snakecase}" value="${selected_row[columns[i].snakecase]}"></div>`;
      }
      add_row_html += `<br/>`;
      add_row_html += `<div class="row-input">`;
      add_row_html += `<button onclick="update_row(${i})">Update row</button>`;
      add_row_html += `<button onclick="delete_row(${i})" id="delete">&#128465; </button>`;
      add_row_html += `</div>`;
      
      add_row_html += `</div>`;
      document.getElementById('row-editor-container').innerHTML = add_row_html;
      document.getElementById('action-button-container').innerHTML = '<button id="new-row" onclick="render_add_row_btn()">+ New Row</button>';

    }

    ////
    ////  RENDER TABLE MAKER / EDITOR 
    ////

    //  Start the table_maker interface.
    function boot_table_maker() {
      //  Reset the global "table" variable, with empty meta data
      table = {
        columns: {
          name: '',
          max_id: 0,
          columns: [{
              "name": "Id",
              "snakecase": "id",
              "unique": true,
              "required": true,
              "reference": false
            },
          ]
        }
      }
      render_table_maker(); //  Render the table. 
      render_add_column();  //  Render the "new column" layout
      render_side_bar();
    }
    //  Go to the add table page
    function render_table_maker() {
      // The top bar
      document.getElementById('table-name-display').innerHTML = `Create a Table`;

      //  The following line grabs the current table name if it exists, to preserve it on rerender.
      let current_table_name = document.getElementById('table-name-input') ? document.getElementById('table-name-input').value : '';  
      //  Render the table name input:
      let table_maker_html = `<div id="table-name-input-container">Table name: 
        <input type="text" id="table-name-input" value="${current_table_name}" onkeydown="render_table_name_snakecase(event)"/></div>`;
      table_maker_html += `<div id="table-snakecase-container">Table snakecase: </div><br/>`;

      //  Render the table:
      table_maker_html += `<table>`;
      table_maker_html += `<tr><th>Column name</th><th>Column snakecase</th><th>Unique?</th><th>Required?</th><th>Foreign key?</th></tr>`;
      ///  Rendering column data... as rows... don't get confused here. 
      let rows = table.columns.columns;
      for (let i = 0; i < rows.length; i++) {
        let selected_class = 'class="selected-row"';
        if (true) {  selected_class = '';  } // TODO: Allow selection / editing of columns
        table_maker_html += `<tr onclick="render_column_editor(${i})" ${selected_class}>`;
        for (let j = 0; j < column_data.length; j++) {
          table_maker_html += `<td>${rows[i][column_data[j][1]]}</td>`;
        }
        // table_string += `<td>&#9999; &nbsp; &#128465;</td>`;
        table_maker_html += `</tr>`;
      }
      table_maker_html += `</table><br/>`;
      document.getElementById('table-display').innerHTML = table_maker_html;
    }

    //  Render table name snake case whenever table name is updated
    function render_table_name_snakecase(e) {
      let table_name = document.getElementById('table-name-input').value + e.key;
      document.getElementById('table-snakecase-container').innerHTML = `Table snakecase: ${table_name.toLowerCase().replace(' ', '-')}`;
    }

    //  Render the add column inputs
    function render_add_column() {
      let columns = table.columns.columns;
      let add_row_html = '<div id="row-editor">';
      add_row_html += '<h3>New row</h3>';
      for (let i = 0; i < column_data.length; i++) {
        const input_types = ['text', 'text', 'checkbox', 'checkbox', 'checkbox'];
        add_row_html += `<div class="row-input">${column_data[i][0]}: <input type="${input_types[i]}" id="i-${column_data[i][1]}"></div>`;
      }

      add_row_html += `<div class="row-input"><button onclick="add_column()">Add column</button></div>`;
      add_row_html += `</div>`;
      document.getElementById('row-editor-container').innerHTML = add_row_html;
      document.getElementById('action-button-container').innerHTML = '<button id="save-new-table" onclick="save_new_table()">+ Save New Table</button>';
    }

    ////
    ////  DATA HANDLING - table rows
    ////
    //  Load a table onto the display
    function load_table(table_name) {
      http.open("GET", `/api/table?db_name=${selected_db}&table_name=${table_name}`);
      http.send();
      http.onreadystatechange = (e) => {
        let response;      
        if (http.readyState == 4 && http.status == 200) {
          table = JSON.parse(http.responseText);
          if (!table.error) {
            render_table();
            render_add_row_btn();
            render_side_bar();
          } else {
            document.getElementById('error').innerHTML = response.msg;
          }
        }
      }
    }

    function load_database(db_name) {
      selected_db = db_name;
      Pantry.get_all_tables(db_name, function(_table_list) {
        if (!_table_list.error) {
          table_list = _table_list;
          render_side_bar();
          if (_table_list) { load_table(_table_list[0]);  }  //  Load the first table on startup
        } else {
          document.getElementById('error').innerHTML = _table_list.msg;
        }
      });
    }

    //  Add a row to the current table
    function add_row() {
      let columns = table.columns.columns;
      let new_row = {};
      for (let i = 0; i < columns.length; i++) {
        let input = document.getElementById("i-" + columns[i].snakecase);
        if (input) {
          new_row[columns[i].snakecase] = input.value;
        }
      }
      http.open("POST", `/api/insert?db_name=${selected_db}&table_name=${table.columns.snakecase}`);  //  "table" is a global variable
      http.send(JSON.stringify(new_row));
      http.onreadystatechange = (e) => {
        let response;      
        if (http.readyState == 4 && http.status == 200) {
          response = JSON.parse(http.responseText);
          if (!table.error) {
            new_row.id = response.id;
            table.rows.push(new_row);
            render_table();
            render_add_row_btn();
          } else {
            document.getElementById('error').innerHTML = response.msg;
          }
        }
      }
    }

    //  Update a row
    function update_row(row_num) {
      let columns = table.columns.columns;
      let row_update = {};
      for (let i = 0; i < columns.length; i++) {
        let input = document.getElementById("i-" + columns[i].snakecase);
        if (input) {
          row_update[columns[i].snakecase] = input.value;
        }
      }
      http.open("POST", `/api/update?db_name=${selected_db}&table_name=${table.columns.snakecase}&id=${table.rows[row_num].id}`);  //  "table" is a global variable
      http.send(JSON.stringify(row_update));
      http.onreadystatechange = (e) => {
        let response;      
        if (http.readyState == 4 && http.status == 200) {
          response = JSON.parse(http.responseText);
          if (!table.error) {
            //  Update the "buffer" data:
            for (let j = 0; j < Object.keys(row_update).length; j++) {
              let key = Object.keys(row_update)[j];
              table.rows[row_num][key] = row_update[key];
            }
            // table.rows.push(new_row);
            render_table();
            render_add_row_btn();
          } else {
            document.getElementById('error').innerHTML = response.msg;
          }
        }
      }
    }

    //  delete a row
    function delete_row(i) {
      http.open("POST", `/api/delete?db_name=${selected_db}&table_name=${table.columns.snakecase}&id=${table.rows[i].id}`);  //  "table" is a global variable
      http.send();
      http.onreadystatechange = (e) => {
        let response;      
        if (http.readyState == 4 && http.status == 200) {
          response = JSON.parse(http.responseText);
          if (!table.error) {
            table.rows.splice(i, 1);
            // table.rows.push(new_row);
            render_table();
            render_add_row_btn();
          } else {
            document.getElementById('error').innerHTML = response.msg;
          }
        }
      }
    }

    ////
    ////  DATA HANDLING - table def and columns
    ////
    function add_column() {
      let new_column = {};
      for (let i = 0; i < column_data.length; i++) {
        let input = document.getElementById("i-" + column_data[i][1]);
        if (input.type == 'text') {
          new_column[column_data[i][1]] = input.value;
        } else if (input.type == 'checkbox') {
          new_column[column_data[i][1]] = input.checked;
        }
      }
      table.columns.columns.push(new_column);
      render_table_maker();
    }

    //  Create new table .json file in Pantry
    function save_new_table() {
      let new_table = table.columns;

      new_table.name = document.getElementById('table-name-input').value;
      new_table.snakecase = new_table.name.toLowerCase().replace(' ', '-');
      http.open("POST", `/api/create-table?db_name=${selected_db}`);
      http.send(JSON.stringify(new_table));
      http.onreadystatechange = (e) => {
        let response;      
        if (http.readyState == 4 && http.status == 200) {
          response = JSON.parse(http.responseText);
          if (!table.error) {
            table_list.push(new_table.snakecase);
            render_side_bar();
          } else {
            document.getElementById('error').innerHTML = response.msg;
          }
        }
      }
    }
  </script>

  <style>
    body {
      color: white;
      display: flex;
      font-family: sans-serif;
      padding: 0px;
      margin: 0px;
      --box-shadow: 2px 2px 10px black;

      --content-bg: hsl(240, 55%, 8%);
      --content-bg-desat: hsl(from var(--content-bg) h calc(s - 40) l);
      --content-bg-desat-dark1: hsl(from var(--content-bg) h calc(s - 40) calc(l - 2));
      --content-bg-desat-light1: hsl(from var(--content-bg) h calc(s - 40) calc(l + 5));
      --content-bg-desat-light2: hsl(from var(--content-bg) h calc(s - 40) calc(l + 10));
      --content-bg-dark2: hsl(from var(--content-bg) h s calc(l - 5));
      --content-bg-dark1: hsl(from var(--content-bg) h s calc(l - 2));
      --content-bg-light1: hsl(from var(--content-bg) h s calc(l + 5));
      --content-bg-light2: hsl(from var(--content-bg) h s calc(l + 10));
      --content-bg-light3: hsl(from var(--content-bg) h s calc(l + 15));

      --action-bg: rgb(43, 3, 38);
      --red-bg: rgb(63, 2, 10);
    }

    /********************/
    /*  Side bar styles */
    /********************/
    #side-bar {
      width: 300px;
      min-height: 100vh;
      background: var(--content-bg-desat-dark1);
      box-sizing: border-box;
    }
    #side-bar h1, #side-bar h3 {
      padding: 10px;
    }
    #side-bar h1 {
      font-size: 1.5em;
      font-family: serif;
      background: black; 
      margin-top: 0px; 
      padding: 15px;
    }
    #side-bar h3 {
      margin-bottom: 0px;
      padding-bottom: 0px;
      opacity: 0.5;
    }
    #side-bar div {
      padding: 10px;
    }
    .db-name::before {
      content: '\25B8  ';
    }
    .db-name.selected::before {
      content: '\25BE  ';
    }
    .table-name, .save-new-table, .db-name {
      cursor: pointer;
      opacity: 0.5;
    }
    .table-name {
      padding-left: 35px !important;
      background:var(--content-bg-desat-light1);
      font-size: 0.8em;
    }
    .selected {
      background: var(--content-bg-desat-light1);
      font-weight: bold;
      opacity: 1;
    }
    .db-name.selected {
      background: var(--content-bg-desat);
    }
    .table-name:hover, .save-new-table:hover, .db-name:hover {
      background: var(--content-bg-desat-light2);
      color: white;
      opacity: 1;
    }
    .save-new-table {
      color: rgba(255,255,255,0.5);
    }
    
    /*  Main content  */
    #page-content {
      text-align: center;
      padding-top: 0px;
      background: var(--content-bg-desat);
      min-height: 100vh;
      flex-grow: 1;
      position: relative;
    }
    #top-bar {
      width: 100%;
      position: relative;   
      background: var(--content-bg-desat-dark1);
      padding: 20px;
      box-sizing: border-box;
      text-align: left;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /*  Log in   */
    #user-auth {
      display: relative;
    }
    #auth-input-box {
      position: absolute;
      min-width: 230px;
      min-height: 230px;
      top: 70px;
      right: 0px;
      background: var(--content-bg);
      border: solid var(--content-bg-light1) 3px;
      box-shadow: var(--box-shadow);
      padding: 15px;
      box-sizing: border-box;
    }


    #table-name-display {
      padding: 0px;
      margin: 0px;
      font-weight: normal;
      font-size: 1em;
    }
    table {
      margin: 30px auto;
      width: 75%;

      border-collapse: collapse;
      box-shadow: var(--box-shadow);
    }
    tr:nth-child(even) {
      background: var(--content-bg-light1);
    }
    tr:nth-child(odd) {
      background: var(--content-bg-light2);
    }
    tr:nth-child(1) { /*  The header row  */
      background: var(--content-bg-dark2);
    }
    tr:not(tr:nth-child(1)):hover {
      cursor: pointer;
      background: var(--content-bg-light3);
    }
    tr.selected-row {
      background: var(--content-bg-light3);
      font-weight: bold;
    }
    td, th {
      /* border: 1px solid white; */
      padding: 15px;
    }

    /*  Selected row / row editor */
    #row-editor {
      margin: auto;
      width: 400px;
      background: var(--content-bg-light1);
      padding: 20px;
      box-sizing: border-box;
      box-shadow: var(--box-shadow);
      position: absolute;
      bottom: 20px;
      left: 20px;
    }
    #row-editor h3 {
      margin: 0px;
      padding: 0px;
      padding-bottom: 10px;
    }
    #row-editor .row-input {
      display: flex;
      justify-content: space-between;
      margin: 5px 0px;
    }
    input {
      background: var(--content-bg-light3);
      color: white;
      border: none;
      padding: 4px;
      font-size: 1em;
    }
    button {
      background: var(--action-bg);
      box-shadow: var(--box-shadow);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 1em;
      cursor: pointer;

    }
    #row-editor #delete {
      background: var(--red-bg);
      cursor: pointer;
    }

    /* Button to create a new row.   */
    #action-button-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
    }

    /*********************************/
    /*        Table editor           */
    /*********************************/
    #table-name-input-container {
      margin: 20px;

    }

  </style>

</html>